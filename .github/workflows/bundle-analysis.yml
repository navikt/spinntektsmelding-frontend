name: Bundle Analysis

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: bundle-${{ github.event.pull_request.head.repo.full_name }}-${{ github.event.pull_request.head.ref }}
  cancel-in-progress: true

env:
  NPM_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}
  NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: "24.0"
          registry-url: "https://npm.pkg.github.com"

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061

      - name: Cache pnpm files
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: |
            ~/.pnpm-store

          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Cache Next.js build cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: .next/cache
          key: ${{ runner.os }}-next-cache-${{ hashFiles('pnpm-lock.yaml', 'next.config.js', 'tsconfig.json') }}
          restore-keys: |
            ${{ runner.os }}-next-cache-

      - name: Build with stats
        run: pnpm build
        env:
          ANALYZE: true

      - name: Generate bundle stats JSON
        run: |
          mkdir -p .next/analyze
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          // Les .next/build-manifest.json for chunk-info
          const buildManifestPath = '.next/build-manifest.json';
          const appBuildManifestPath = '.next/app-build-manifest.json';

          const stats = { assets: [], timestamp: Date.now() };

          // Samle alle JS-filer fra .next/static
          function collectJsFiles(dir, assets) {
            if (!fs.existsSync(dir)) return;
            const files = fs.readdirSync(dir, { withFileTypes: true });
            for (const file of files) {
              const fullPath = path.join(dir, file.name);
              if (file.isDirectory()) {
                collectJsFiles(fullPath, assets);
              } else if (file.name.endsWith('.js')) {
                const stat = fs.statSync(fullPath);
                assets.push({
                  name: path.relative('.next', fullPath),
                  size: stat.size
                });
              }
            }
          }

          collectJsFiles('.next/static', stats.assets);

          // Sorter etter stÃ¸rrelse
          stats.assets.sort((a, b) => b.size - a.size);

          // Total stÃ¸rrelse
          stats.totalSize = stats.assets.reduce((sum, a) => sum + a.size, 0);

          fs.writeFileSync('.next/analyze/bundle-stats.json', JSON.stringify(stats, null, 2));
          console.log(`Generated stats for ${stats.assets.length} assets, total: ${(stats.totalSize / 1024 / 1024).toFixed(2)} MB`);
          EOF

      - name: Upload bundle stats
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: bundle-stats
          path: .next/analyze/bundle-stats.json

      - name: Download base bundle stats
        uses: dawidd6/action-download-artifact@fe9d59ce33ce92db8a6ac90b2c8be6b6d90417c8
        if: github.event_name == 'pull_request'
        continue-on-error: true
        with:
          workflow: bundle-analysis.yml
          branch: main
          name: bundle-stats
          path: .next/analyze-base/

      - name: Compare bundle sizes
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          function readStats(filePath) {
            if (!fs.existsSync(filePath)) return null;
            return JSON.parse(fs.readFileSync(filePath, 'utf-8'));
          }

          function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(Math.abs(bytes)) / Math.log(k));
            const prefix = bytes > 0 ? '+' : '';
            return `${prefix}${(bytes / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`;
          }

          function formatSize(bytes) {
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(Math.abs(bytes)) / Math.log(k));
            return `${(bytes / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`;
          }

          const current = readStats('.next/analyze/bundle-stats.json');
          const base = readStats('.next/analyze-base/bundle-stats.json');

          if (!current) {
            console.log('No current stats found');
            process.exit(0);
          }

          const currentSizes = current.assets.reduce((acc, a) => { acc[a.name] = a.size; return acc; }, {});
          const baseSizes = base ? base.assets.reduce((acc, a) => { acc[a.name] = a.size; return acc; }, {}) : {};

          const currentTotal = current.totalSize;
          const baseTotal = base ? base.totalSize : 0;

          let report = '## ðŸ“¦ Bundle Size Report\n\n';

          if (base) {
            const diff = currentTotal - baseTotal;
            const pctChange = baseTotal > 0 ? ((diff / baseTotal) * 100).toFixed(1) : 'âˆž';
            const emoji = diff > 0 ? 'ðŸ“ˆ' : diff < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
            
            report += `| Metric | Base | Current | Change |\n`;
            report += `|--------|------|---------|--------|\n`;
            report += `| **Total JS** | ${formatSize(baseTotal)} | ${formatSize(currentTotal)} | ${emoji} ${formatBytes(diff)} (${pctChange}%) |\n\n`;

            // Finn nye, fjernede og endrede chunks
            const allChunks = new Set([...Object.keys(currentSizes), ...Object.keys(baseSizes)]);
            const changes = [];
            
            for (const chunk of allChunks) {
              const currSize = currentSizes[chunk] || 0;
              const baseSize = baseSizes[chunk] || 0;
              const chunkDiff = currSize - baseSize;
              
              if (chunkDiff !== 0) {
                changes.push({ chunk, currSize, baseSize, diff: chunkDiff });
              }
            }
            
            // Sorter etter absolutt endring
            changes.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));

            if (changes.length > 0) {
              report += `### Biggest Changes\n\n`;
              report += `| Chunk | Base | Current | Change |\n`;
              report += `|-------|------|---------|--------|\n`;

              for (const { chunk, currSize, baseSize, diff } of changes.slice(0, 10)) {
                const chunkEmoji = diff > 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
                const shortName = chunk.length > 50 ? '...' + chunk.slice(-47) : chunk;
                const baseStr = baseSize > 0 ? formatSize(baseSize) : '_new_';
                const currStr = currSize > 0 ? formatSize(currSize) : '_removed_';
                
                report += `| \`${shortName}\` | ${baseStr} | ${currStr} | ${chunkEmoji} ${formatBytes(diff)} |\n`;
              }
            } else {
              report += `> âœ… No changes in bundle sizes\n`;
            }

            // Advarsel ved stor Ã¸kning
            if (diff > 50 * 1024) {
              report += `\n> âš ï¸ **Warning:** Bundle size increased by more than 50KB\n`;
            }
          } else {
            report += `| Metric | Size |\n`;
            report += `|--------|------|\n`;
            report += `| **Total JS** | ${formatSize(currentTotal)} |\n\n`;

            report += `### Largest Chunks\n\n`;
            report += `| Chunk | Size |\n`;
            report += `|-------|------|\n`;
            
            for (const asset of current.assets.slice(0, 10)) {
              const shortName = asset.name.length > 50 ? '...' + asset.name.slice(-47) : asset.name;
              report += `| \`${shortName}\` | ${formatSize(asset.size)} |\n`;
            }

            report += `\n> â„¹ï¸ No baseline found for comparison (first run on main branch)\n`;
          }

          fs.writeFileSync('bundle-report.md', report);
          console.log(report);
          EOF

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'bundle-report.md';

            if (!fs.existsSync(reportPath)) {
              console.log('No report found');
              return;
            }

            const report = fs.readFileSync(reportPath, 'utf-8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Bundle Size Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
